# AWS WAF 和 CloudWatch 成本效益分析

## 📊 成本概覽

| 服務           | 月費用 | 年費用  | 說明           |
| -------------- | ------ | ------- | -------------- |
| **AWS WAF**    | $5-10  | $60-120 | API 防火牆保護 |
| **CloudWatch** | $1-2   | $12-24  | 監控和日誌     |
| **合計**       | $6-12  | $72-144 |                |

---

## 🛡️ AWS WAF ($5-10/月)

### 費用構成

```
基礎費用:
- Web ACL: $5.00/月
- 規則費用: $1.00/規則/月 × 4 規則 = $4.00
- 請求費用: $0.60/百萬次請求

範例計算（低流量）:
$5 (Web ACL) + $4 (4個規則) = $9/月

範例計算（高流量，100萬次請求/月）:
$5 + $4 + $0.60 = $9.60/月
```

### 🎯 功能價值

#### 1. 速率限制（Rate Limiting）

**保護場景：**

```
❌ 沒有 WAF 的情況：
攻擊者發送 100,000 次請求/分鐘
→ Lambda 被觸發 100,000 次
→ 費用：~$2 (Lambda)
→ DynamoDB 讀寫費用：~$5
→ API 可能崩潰
→ 總損失：$7+ 且服務中斷

✅ 有 WAF 的情況：
攻擊者發送 100,000 次請求/分鐘
→ WAF 攔截 98,000 次（超過速率限制）
→ 只有 2,000 次到達 Lambda
→ 費用：$0.04 (Lambda)
→ 服務正常運行
→ 省錢且安全
```

**實際價值：** 每次 DDoS 攻擊可能導致的損失：

| 項目          | 無 WAF   | 有 WAF |
| ------------- | -------- | ------ |
| Lambda 費用   | $20-100  | < $1   |
| DynamoDB 費用 | $50-500  | < $5   |
| 服務中斷損失  | 無法估計 | $0     |
| 信譽損失      | 嚴重     | 無     |

#### 2. SQL 注入 / XSS 防護

**保護場景：**

```javascript
// 攻擊者嘗試 SQL 注入
POST /links
{
  "target": "https://evil.com'; DROP TABLE links--",
  "code": "hack"
}

❌ 沒有 WAF：
→ 請求到達 Lambda
→ 可能繞過應用層驗證
→ 資料庫風險

✅ 有 WAF：
→ WAF 在 API Gateway 前攔截
→ 返回 403 Forbidden
→ Lambda 甚至不會被觸發
→ 零風險
```

#### 3. 已知惡意輸入過濾

**AWS 託管規則集：**

- Core Rule Set (CRS)：防禦 OWASP Top 10
- Known Bad Inputs：封鎖已知攻擊模式
- 自動更新，無需維護

**價值：** 專業安全團隊維護的規則，相當於僱用安全專家的一小部分成本。

#### 4. 地理封鎖（可選）

```
場景：90% 的攻擊來自特定國家

配置：封鎖高風險國家
waf_blocked_countries = ["CN", "RU", "KP"]

結果：
- 攻擊流量減少 90%
- Lambda 成本降低
- 服務更穩定
```

### ⚠️ 不採用 WAF 的風險

#### 風險 1：DDoS 攻擊 → 高額費用

```
真實案例場景：
某日凌晨 3 點，攻擊者發動 DDoS
→ 1,000,000 次請求/分鐘持續 1 小時
→ 總請求：60,000,000 次

費用計算（無 WAF）：
- Lambda 調用：60M × $0.0000002 = $12
- Lambda 運行時間：60M × 100ms × $0.0000166667 = $100
- DynamoDB 寫入：60M × $1.25/百萬 = $75
- DynamoDB 讀取：60M × $0.25/百萬 = $15
→ 單次攻擊總費用：$202

一年遭受 5 次攻擊：$1,010
WAF 年費用：$72-120

💡 結論：WAF 投資回報率 > 800%
```

#### 風險 2：資料外洩

```
SQL 注入成功 → 所有短網址被竊取
→ 品牌信譽損失
→ GDPR 罰款（如適用）
→ 用戶流失
→ 潛在法律訴訟

估計損失：無法計算，但遠超 $10/月
```

#### 風險 3：服務中斷

```
持續攻擊 → Lambda 併發限制
→ 正常用戶無法使用服務
→ 業務損失
→ 客戶投訴

停機成本：
- 小型專案：$100-1,000/小時
- 中型專案：$1,000-10,000/小時
```

### 💡 WAF 建議

#### 推薦場景：✅ **強烈建議使用**

1. **生產環境**：必須
2. **公開 API**：必須
3. **有付費用戶**：必須
4. **處理敏感資料**：必須

#### 可選場景：⚠️ 視情況而定

1. **純開發/測試環境**：可選
2. **內部使用 API（VPC 內）**：可選
3. **非常低流量（<100 請求/天）**：可選

#### 替代方案（不推薦）

如果真的要節省 $10/月：

```typescript
// 在 Lambda 中實作基本速率限制
import { RateLimiter } from "rate-limiter-flexible";

const rateLimiter = new RateLimiter({
  points: 100, // 100 次請求
  duration: 60, // 每 60 秒
});

export async function handler(event) {
  const ip = event.requestContext.http.sourceIp;

  try {
    await rateLimiter.consume(ip);
  } catch (error) {
    return {
      statusCode: 429,
      body: JSON.stringify({ message: "Too many requests" }),
    };
  }

  // ... 正常處理
}
```

**問題：**

- ❌ 攻擊流量仍然觸發 Lambda（產生費用）
- ❌ 無 SQL 注入/XSS 防護
- ❌ 需要自己維護規則
- ❌ 消耗 Lambda 運行時間

---

## 📊 CloudWatch ($1-2/月)

### 費用構成

```
日誌存儲：
- 免費額度：5 GB/月
- 超出費用：$0.50/GB

範例計算（低流量）:
- Lambda 日誌：0.5 GB/月
- WAF 日誌：0.3 GB/月
- API Gateway 日誌：0.2 GB/月
→ 總計：1 GB < 5 GB 免費額度
→ 費用：$0

範例計算（中等流量）:
- 總日誌：8 GB/月
- 超出：3 GB × $0.50 = $1.50/月

警報費用：
- $0.10/警報/月 × 4 個警報 = $0.40/月

總計：$0-2/月（大部分在免費額度內）
```

### 🎯 功能價值

#### 1. 錯誤監控

**場景：Authorizer 驗證失敗**

```
無 CloudWatch：
❌ 用戶無法登入
❌ 您不知道發生什麼
❌ 用戶抱怨 → 您開始調查 → 花 2 小時找問題
❌ 損失：2 小時 × $50/小時 = $100

有 CloudWatch：
✅ 警報立即通知「Authorizer 錯誤率 > 10%」
✅ 查看日誌，5 分鐘找到問題
✅ 快速修復
✅ 損失：最小
```

#### 2. 性能監控

**追蹤指標：**

```
- Lambda 執行時間
- API Gateway 延遲
- DynamoDB 節流
- 錯誤率趨勢
```

**價值：**

```
發現：Lambda 執行時間從 50ms 增加到 500ms
→ 調查發現：DynamoDB 查詢效率低
→ 優化查詢
→ 降低 Lambda 成本 20%
→ 每月省 $10

CloudWatch 成本：$1/月
省下的錢：$10/月
投資回報率：1000%
```

#### 3. 安全事件追蹤

**WAF 攻擊日誌：**

```json
{
  "timestamp": "2025-10-01T10:30:00Z",
  "action": "BLOCK",
  "ruleId": "RateLimitRule",
  "clientIp": "123.45.67.89",
  "httpRequest": {
    "uri": "/links",
    "method": "POST"
  }
}
```

**價值：**

- 了解攻擊模式
- 識別攻擊者 IP
- 調整防禦策略
- 生成安全報告

#### 4. 合規要求

**GDPR / SOC2 / ISO 27001 要求：**

- ✅ 必須有日誌記錄
- ✅ 必須有監控警報
- ✅ 必須保留審計追蹤

**不合規的成本：**

- GDPR 罰款：最高 €20M 或年收入 4%
- 客戶信任損失：無價

### ⚠️ 不採用 CloudWatch 的風險

#### 風險 1：問題發現延遲

```
情境：Lambda Authorizer 由於 SSM 權限問題失敗

無 CloudWatch：
❌ Day 1: 用戶開始抱怨無法使用
❌ Day 2: 客服收到大量投訴
❌ Day 3: 您才開始調查
❌ Day 4: 找到問題並修復
→ 損失：4 天的用戶流失 + 信譽損失

有 CloudWatch：
✅ 5 分鐘：警報觸發
✅ 10 分鐘：查看日誌找到原因
✅ 30 分鐘：修復完成
→ 損失：最小，用戶可能沒感覺
```

#### 風險 2：無法優化成本

```
無監控數據：
❌ 不知道哪個 Lambda 最耗時
❌ 不知道哪個 API 最常被調用
❌ 無法針對性優化
→ 持續浪費成本

有 CloudWatch：
✅ 數據驅動優化
✅ 識別瓶頸
✅ 降低成本
→ 可能省下的錢 > CloudWatch 費用
```

#### 風險 3：安全盲點

```
攻擊發生但您不知道：
❌ 持續的低強度攻擊
❌ 緩慢的資料洩露
❌ 異常的存取模式
→ 等發現時為時已晚

有 CloudWatch：
✅ 實時監控異常
✅ 趨勢分析
✅ 及早發現問題
```

### 💡 CloudWatch 建議

#### 推薦配置：最小化成本

```hcl
# 只保留關鍵日誌，縮短保留期
resource "aws_cloudwatch_log_group" "authorizer" {
  retention_in_days = 7  # 從 30 天改為 7 天
}

# 只設置關鍵警報
resource "aws_cloudwatch_metric_alarm" "critical_errors" {
  alarm_name = "critical-errors-only"
  threshold  = 50  # 只在嚴重錯誤時警報
}
```

**成本降低：**

- 30 天保留 → 7 天保留：省 70% 日誌費用
- 4 個警報 → 2 個警報：省 50% 警報費用
- 月費用：$1-2 → $0.20-0.50

#### 完全不用 CloudWatch 的替代方案（不推薦）

```typescript
// 自建日誌系統（非常不推薦）
export async function handler(event) {
  try {
    // ... 業務邏輯
  } catch (error) {
    // 發送到自己的日誌服務
    await fetch("https://my-log-service.com/log", {
      method: "POST",
      body: JSON.stringify({
        error: error.message,
        timestamp: new Date().toISOString(),
      }),
    });
  }
}
```

**問題：**

- ❌ 需要維護自己的日誌系統
- ❌ 可能更貴（自建服務器）
- ❌ Lambda 執行時間增加（產生費用）
- ❌ 不可靠（Lambda 崩潰時日誌也丟失）

---

## 💰 總成本效益分析

### 情境比較

#### 情境 1：個人專案 / MVP

**特徵：**

- 流量很低（<1000 請求/天）
- 非關鍵業務
- 無付費用戶
- 預算有限

**建議：**

```hcl
# 最小配置
enable_waf            = false  # 暫時不用
enable_authentication = true   # 用 JWT

# CloudWatch 最小化
log_retention_days = 3  # 只保留 3 天
```

**月費用：** $0-0.50  
**風險：** 中等（可接受）

---

#### 情境 2：小型商業專案

**特徵：**

- 中等流量（1,000-10,000 請求/天）
- 有付費用戶
- 需要穩定性
- 預算：$50-200/月

**建議：**

```hcl
enable_waf            = true   # 強烈建議
enable_authentication = true

log_retention_days = 7
waf_rate_limit_per_5min = 2000
```

**月費用：** $7-12  
**投資回報率：** 非常高  
**風險：** 低

---

#### 情境 3：中大型專案

**特徵：**

- 高流量（>10,000 請求/天）
- 關鍵業務
- 多付費用戶
- 需要合規

**建議：**

```hcl
enable_waf            = true   # 必須
enable_authentication = true   # 必須

log_retention_days = 30  # 合規要求
waf_rate_limit_per_5min = 5000

# 額外：SNS 警報通知
```

**月費用：** $10-15  
**必要性：** 必須投資  
**風險：** 不使用的風險極高

---

## 🎯 最終建議

### 推薦配置（平衡成本與安全）

```hcl
# terraform.tfvars

# 生產環境：必須
enable_waf            = true
enable_authentication = true

# 適度的保留期（符合大部分需求）
log_retention_days = 7  # 7 天足夠排查問題

# 合理的速率限制
waf_rate_limit_per_5min = 2000

# 月費用：$6-10
# 提供：企業級安全保護
```

### 省錢策略（不犧牲安全）

1. **縮短日誌保留期**

   ```
   30 天 → 7 天：省 70% CloudWatch 費用
   ```

2. **精簡警報數量**

   ```
   只保留最關鍵的 2-3 個警報
   ```

3. **開發環境不用 WAF**

   ```hcl
   # dev.tfvars
   enable_waf = false

   # prod.tfvars
   enable_waf = true
   ```

4. **按需啟用**
   ```
   平時不啟用 → 遇到攻擊時快速啟用
   （但不推薦，因為啟用需要時間）
   ```

### 不推薦完全不用

**原因：**

1. **一次攻擊的損失 > 一年 WAF 費用**

   ```
   單次 DDoS 攻擊損失：$200+
   WAF 年費用：$72-120
   ```

2. **問題排查時間 > CloudWatch 費用**

   ```
   1 小時排查時間價值：$50
   CloudWatch 年費用：$12-24
   ```

3. **安全事故的隱性成本**
   ```
   - 用戶流失
   - 品牌信譽
   - 法律責任
   → 無法用金錢衡量
   ```

---

## 📊 決策樹

```
您的專案是生產環境嗎？
├─ 是
│  └─ 有付費用戶或處理敏感資料嗎？
│     ├─ 是 → ✅ 必須使用 WAF + CloudWatch
│     └─ 否 → ✅ 強烈建議使用
│
└─ 否（開發/測試）
   └─ 預算非常有限嗎？
      ├─ 是 → ⚠️ 可以暫時不用，但生產環境必須加上
      └─ 否 → ✅ 建議使用（養成良好習慣）
```

---

## 結論

**WAF ($5-10/月)：**

- ✅ 投資回報率極高
- ✅ 一次攻擊的損失 >> 年費用
- ✅ 生產環境**強烈建議**使用
- ⚠️ 個人專案可選，但有風險

**CloudWatch ($1-2/月)：**

- ✅ 大部分在免費額度內
- ✅ 問題排查必備
- ✅ 成本優化依據
- ✅ **幾乎沒理由不用**

**總建議：**
💡 除非是純開發環境或極低流量的個人專案，否則**強烈建議兩者都使用**。

$6-12/月的投資換來的是：

- 🛡️ 企業級安全保護
- 📊 完整的監控可視性
- 🚀 更好的用戶體驗
- 💰 長期來看反而省錢

這是非常划算的投資！
